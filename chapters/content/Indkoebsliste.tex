\section{Indkøbsliste} \fxnote{Burde nok være før overvågningslisten? - Troels}
Fra vores prototype interviews, \myref{section:interview2}, blev der ønsket muligheden for indkøbslister som både kunne bruges individuelt samt deles med andre, hvorpå der både kunne være tilbud eller blot generelle varer. 
Dette er desuden user story nr. 1 - 6, som findes i \myref{sec:krav}. 
Det er krav at indkøbslisten kan: Oprettes, tilføjes varer til, se valgte tilbud, aftjekke varer (ved køb), dele med andre brugere og tilgås fra smartphones.

\subsection{Design}

Indkøbslisten er en meget central del af programmet, da stort set alle andre dele tilføjer varer til indkøbslisterne.
Det vigtigste for indkøbslisten er at den både kan vise generelle varer og specifikke tilbud. 
Hver indkøbsliste skal også understøtte at den kan deles med andre brugere. 
\subsection{Implementering}

Indekssiden for indkøbslister tilgås via knappen i menubaren, eller via urlen ``/ShoppingLists''.
På den kan en bruger se hvilke indkøbslister personen har, disse er opdelt således at de delte lister er separeret fra de personlige.
Der er også en kort forklarende tekst, som oplyser brugeren om hvad der er muligt at bruge denne del af programmet til.
Der er en knap til at oprette en ny indkøbsliste, den åbner en såkaldt ``Modal'', som er en lille pop-up boks, hvori brugeren kan skrive indkøbslistens navn. 
Der er på denne side også muligt at ændre titlen på en indkøbsliste eller slette den.

Ved at klikke på knappen ``Tilføj og fjern varer'' eller blot på en indkøbsliste vil man tilgå en ny side som viser indholdet af den.
Fra denne side er det nu muligt at dele indkøbslisten med andre bruger baseret på deres e-mail adresse i programmet.
Det er samtidig muligt at se hvilke personer den er delt med på nuværende tidspunkt.
På siden kan brugere også tilføje nye varer til deres indkøbsliste, det er også muligt at specificere mængden og en tilhørende enhed til hver vare, men dette er valgfrit.
Efter en vare er tilføjet til en indkøbsliste forsøger programmet at finde tilbud som passer dertil, dette forgår i metoden ``GetOffersForItem'' i ``ShoppingListController.cs'', og kan ses på \myref{getoffersforitem}.

\begin{lstlisting}[caption="Metoden ``GetOffersForItem'' finder relevante tilbud og returner dem som en liste", label=getoffersforitem]
public static List<Offer> GetOffersForItem(IDataBaseContext db, Item item, User user)
{
    return db.OffersFilteredByUserPrefs(user).Where(x => 
     	x.Heading.ToLower().Contains(item.Name.ToLower() + " ") 
     || x.Heading.ToLower().Contains(" " + item.Name.ToLower()) 
     || String.Equals(x.Heading.ToLower(), item.Name.ToLower())).ToList();
}
\end{lstlisting}

Denne metode vil søge de tilbud, som er i butikker brugeren kan lide og ikke er på listen over til brugeren ikke ønsker at købe, som angivet i brugerindstilliger.
Den naive implementering af denne metode ville være at anvende ``String.Contains'' metoden, som returnerer sand hvis den angivne string er en substring af den som metoden kaldes på. 
Men dette vil give unødige falske-positive, eksempelvis hvis en bruger vil købe varen ``Burger'', så vil tilbud på ``hamburgerryg'' blive inkluderet.
Derfor er alle tilbud for en given vare kun med i listen hvis varens navn findes efterfulgt af et mellemrum, eller forud for et mellemrum, eller passer fuldstændigt.
For at tilgå denne information kan brugeren trykke på den blå knap ud for  ``Se tilbud'', dette vil udvide tabellen således brugeren kan se tilbudene og vælge et af dem.
Hvis der vælges et at tilbudene vil varen blive erstattet af informationen om tilbudet, da dette oftere er mere specifikt.
Dette gøres vha. feltet ``selectedOffer'' på ``shoppingList\_Item''.

På \myref{OffersFilteredByUserPrefs} ses metoden ``OffersFilteredByUserPrefs'', som blev kaldt i \myref{getoffersforitem}. Denne metode sørger for at brugeren kun ser tilbud som de ikke vil filtrere væk. F.eks. hvis man er allergisk over for mandler, kan man her filtrere tilbud væk, som har noget med mandler i sit navn. Der er taget et valg om at tilbud med kommaer og ``eller'' i sit navn, skal filtreres væk. Dette er fordi de bliver meget intetsigende og kan skabe forvirring for brugeren. Et eksempel kan være at man søger på leverpostej, og tilbudet hedder: ``Leverpostej eller kødpølse''. Hvis der så på brugerens indkøbsliste står ``Leverpostej eller kødpølse'', kan de være usikre på hvad det egentlig var de skulle købe. Metoden kaldes alle steder hvor der skal vises tilbud på hjemmesiden.

\begin{lstlisting}[caption="Metoden ``OffersFilteredByUserPrefs'' filtrere tilbud fra som indeholder kommaer\, og ``eller''. Derudover tilføjer det ekstra filtreringer ud fra brugerens opgivede præferencer. Disse sendes som input gennem arrayet af strings. Denne blackliste sendes sammen med hvert offer til metoden ``OfferIsRelevant''\, som tjekker om hvorvidt en vare bør tilføjes til listen af tilbud. Slutteligt returneres resultates som en IEnumerable", label=OffersFilteredByUserPrefs]
public IEnumerable<Offer> OffersFilteredWithString(params string[] args)
{
    var blacklist = new List<string> { ",", "eller" };
                var fromArgs = new List<string>();
    foreach (var str in args)
    {
        fromArgs.AddRange(str.Split(','));
    }
    blacklist.AddRange(fromArgs);
    // If an empty strings if any was given
    blacklist.RemoveAll(x => x.Trim().Equals(string.Empty));

    var res = new List<Offer>();

    foreach (var o in Offers)
    {
        if (OfferIsRelevant(o, blacklist))
        {
            res.Add(o);
        }
    }
    return res;
}
\end{lstlisting}

``OfferIsReleant'' som kaldes af \myref{OffersFilteredByUserPrefs} kan ses på \myref{OfferIsRelevant}. Dette er metoden som giver resultatet om hvorvidt tilbudet skal tilføjes til listen over tilbud eller ej. Hvis den returnere false vil tilbudet ikke blive tilføjet på linie 19 i \myref{OffersFilteredByUserPrefs}.

\begin{lstlisting}[caption="Denne metode kaldet af OffersFilteredByUserPrefs\, sørger for at tilbudet som modtages som input overholder de forskellige krav sat i blacklisten. Der tjekkes også om tilbudet er passende for den nuværende systemtid. Den nuværende systemtid bruges til at ændre tiden i programmet for at loade relevant tilbud\, og bruges udelukkende til fremvisning af funktionalitet og testing. Er resultates true\, tilføjes tilbudet til listen\, hvis resultatet er false tilføjes den ikke.", label=OfferIsRelevant]
private static bool OfferIsRelevant(Offer o, IEnumerable<string> blacklist)
{
    if (o.End < GlobalVariables.CurrentSystemTime)
        return false;

    if(o.Begin > GlobalVariables.CurrentSystemTime)
        return false;

    if (blacklist.Any(item => o.Heading.ToLower().Contains(item.ToLower()) || o.Store.ToLower().Contains(item.ToLower())))
        return false;

    if (o.Unit.Trim() == "")
        return false;

    // Base case.
    return true;
}
\end{lstlisting}


Det er muligt at aftjekke varer som værende købte ved at klikke på deres navn på indkøbslisten. Hvis en bruger holder deres cursor over teksten kommer der en lille besked som viser dette. 
Det er desuden muligt at fjerne varer helt fra indkøbslisten ved at trykke på den røde knap med et kryds under ``Fjern''. 
Der er desuden også mulighed for at rydde hele listen for varer og tilbud.

\subsection{Konklusion}
Det er muligt at have personlige indkøbslister samt at dele dem med andre brugere, hvis en indkøbsliste er delt kan alle brugerne anvende den som var det deres egne. 
Det er også muligt at tilføje varer, aftjekke dem, og tilgå tilbud baseret på de varer man har tilføjet. 
Implementeringen udfylder alle user stories, det er dog op til brugertestene at afgøre om det er tilstrækkeligt udført. 
